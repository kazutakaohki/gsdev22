<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒª</title>
    <link rel="stylesheet" href="style.css" />
  </head>

  <body>
    <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºç”»é¢ -->
    <h1 class="title">To Do List v.2</h1>
    <form>
      <ul>
      <li><input
        type="date"
        id="uname"
        class="name"
        placeholder="æœŸé™ã‚’å…¥åŠ›ã—ã¦ä¸‹ã•ã„"
      /></li>
      <li><textarea
        class="textarea"
        id="text"
        cols="30"
        rows="10"
        placeholder="ã‚¿ã‚¹ã‚¯ã‚’å…¥åŠ›ã—ã¦ä¸‹ã•ã„"
      ></textarea></li>
      <li><button id="send">ç™»éŒ²</button></li>
    </ul>
    </form>
      <div id="output" style="overflow: auto; height: 600px"></div>
    </div>

    <!-- //  ä»¥ä¸‹ã€jquery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <!-- // ä»¥ä¸‹ã€Firebase -->
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";

      // è¿½åŠ 
      import {
        getDatabase,
        ref,
        push,
        set,
        onChildAdded,
        remove,
        onChildRemoved,
      } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

      // TODO: Add SDKs for Firebase products that you want to use
      // https://firebase.google.com/docs/web/setup#available-libraries

      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyAlH0HWZqIvZ97CvXav5qpdgkjD5m3Ji0Q",
        authDomain: "gs-firebase-lesson.firebaseapp.com",
        projectId: "gs-firebase-lesson",
        storageBucket: "gs-firebase-lesson.appspot.com",
        messagingSenderId: "936725735393",
        appId: "1:936725735393:web:9f0e721636d1f1b9ca14a0",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);

      //   è¿½åŠ 2
      const db = getDatabase(app); //RealtimeDBã«æ¥ç¶š
      const dbRef = ref(db, "chat"); //RealtimeDBå†…ã®"chat"ã‚’ä½¿ã†

      // ãƒ‡ãƒ¼ã‚¿é€ä¿¡å‡¦ç†

      $("#send").on("click", function () {
        // alert(1)//å‹•ã„ãŸã‚‰alertã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã—ã¦ãŠãã¾ã—ã‚‡ã†ï¼
        // é€ä¿¡ã®å‡¦ç†ã‚’è¨˜è¿°ã—ã¦ã„ãã¾ã™ğŸ¤—

        // id='uname' ã¤ã¾ã‚Š #uname åå‰ã®ã¨ã“ã‚
        // id='text' ã¤ã¾ã‚Š #text ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®ã¨ã“ã‚
        const text = $("#text").val();
        const uname = $("#uname").val();

        // ãƒ‡ãƒ¼ã‚¿ã®å¡Šã‚’ä½œæˆã—ã¦ã„ã‚‹
        const msg = {
          uname: $("#uname").val(),
          text: $("#text").val(),
        };

        //ãƒ¦ãƒ‹ãƒ¼ã‚¯KEYã‚’ç”Ÿæˆ = çµ¶å¯¾ã«ã‹ã¶ã‚‰ãªã„ç•ªå·ã¿ãŸã„ãªã‚‚ã®
        const newPostRef = push(dbRef);
        //"chat"ã«ãƒ¦ãƒ‹ãƒ¼ã‚¯KEYã‚’ã¤ã‘ã¦ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²
        set(newPostRef, msg);

        // alert(uname + text);ã€€å…¥åŠ›ã®ãƒã‚§ãƒƒã‚¯ã‚’ã—ã¾ã—ãŸ
      });

      // Enterã‚­ãƒ¼ã§é€ä¿¡

      // ãƒ‡ãƒ¼ã‚¿å—ä¿¡å‡¦ç†

      onChildAdded(dbRef, function (data) {
        const msg = data.val();
        const key = data.key;

        // è¡¨ç¤ºç”¨ãƒ†ã‚­ã‚¹ãƒˆãƒ»HTMLã‚’ä½œæˆ
        // let h = "<p>";
        // h += msg.uname;
        // h += "<br>";
        // h += msg.text;
        // h += "</p>";

        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒªãƒ†ãƒ©ãƒ«
        let hh = `
            <div class="message" data-key=${key}>
              <input type="text" value=${msg.uname} class="uname"/>
              <input type="text" value=${msg.text} class="text"/>
              <p class="update">æ›´æ–°</p>
              <p class="delete">å®Œäº†</p>
            </div>
          `;
        $("#output").append(hh); //#outputã®æœ€å¾Œã«è¿½åŠ 
        // é€ä¿¡ã—ãŸã‚‰å…¥åŠ›æ¬„ã‚’ç©ºã«ã™ã‚‹
        $("#uname").val("");
        $("#text").val("");
      });

      // ã‚³ãƒ¡ãƒ³ãƒˆå‰Šé™¤æ©Ÿèƒ½
      $(document).on("click", ".delete", function () {
        //ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸè¦ªã®éµã‚’å–å¾—ã™ã‚‹
        const dbid = $(this).parent().data().key;

        console.log(dbid); //Firebaseã®id

        remove(ref(db, "chat/" + dbid));

        //htmlã‚’æ¶ˆã™æ–¹æ³•
        $(this).parent().remove();
      });

      // æ›´æ–°å‡¦ç†
      $(document).on("click", ".update", function () {
        const dbid = $(this).parent().data().key;

        const nameValue = $(this).siblings(".uname").val();
        const textValue = $(this).siblings(".text").val();

        console.log(nameValue);
        console.log(textValue);
        //ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸè¦ªã®éµã‚’å–å¾—ã™ã‚‹

        //æ›´æ–°å‡¦ç†
        set(ref(db, "chat/" + dbid), {
          uname: nameValue,
          text: textValue,
        });
      });
    </script>
  </body>
</html>


<!-- æœ¬ç•ªã‚µãƒ¼ãƒ“ã‚¹ã‚’ -->